# 一、数据切分
## 1、垂直（纵向）切分
### 垂直分库
    根据业务耦合性，将关联度低的不同表存储在不同的数据库。类似于系统拆分、微服务治理做法类似。
### 垂直分表
    基于数据库中的"列"进行，某个表字段较多，可以新建一张扩展表，将不经常用或字段长度较大的字段拆分出去到扩展表中。大表拆小表。
### 优缺点
##### 优点：
	解决业务系统层面的耦合，业务清晰。
	与微服务的治理类似，也能对不同业务的数据进行分级管理、维护、监控、扩展等。
	高并发场景下，垂直切分一定程度的提升IO、数据库连接数、单机硬件资源的瓶颈。
##### 缺点：
	部分表无法join，只能通过接口聚合方式解决，提升了开发的复杂度
	分布式事务处理复杂
	依然存在单表数据量过大的问题（需要水平切分）
垂直切分后，数据行数还是很大，存在单库读写、存储的瓶颈，需要进行水平拆分。
## 2、水平（横向）切分
	将同一个表按不同的条件分散到多个数据库或多个表中，每个表中只包含一部分数据，从而使得单个表的数据量变小，达到分布式的效果。
### 优缺点
##### 优点：
	不存在单库数据量过大、高并发的性能瓶颈，提升系统稳定性和负载能力
	应用端改造较小，不需要拆分业务模块
##### 缺点：
	跨分片的事务一致性难以保证
	跨库的join关联查询性能较差
	数据多次扩展难度和维护量极大
# 二、典型的数据分片规则
## 1、根据数值范围
	按照时间区间或ID区间来切分。例如：某些系统中使用的"冷热数据分离"，将一些使用较少的历史数据迁移到其他库中，业务功能上只提供热点数据的查询。
### 优缺点
##### 优点：
	单表大小可控。
	天然便于水平扩展。整个分片集群扩容，只需要添加节点即可，不需要对历史数据进行迁移。
	使用分片字段进行范围查找时，连续分片可快速定位分片进行快速查询，有效避免跨分片查询的问题。
##### 缺点：
	热点数据成为性能瓶颈。例如：例如按时间字段分片，有些分片存储最近时间段内的数据，可能会被频繁的读写，而有些分片存储的历史数据，则很少被查询。
## 2、根据数值取模
	一般采用hash取模mod的切分方式。如果是数字可以直接取模。
### 优缺点
##### 优点：
	数据分片相对比较均匀，不容易出现热点和并发访问的瓶颈
##### 缺点：
	后期分片集群扩容时，需要迁移旧的数据（使用一致性hash算法能较好的避免这个问题）（一般分片为2的n次方，扩容，直接从库升为主库。）
	容易面临跨分片查询的复杂问题。无分片键查询语句无法定位库表，需要全库表发起查询，再在内存中合并数据，取最小集返回给应用，分库反而成为拖累。
# 三、分库分表带来的问题
    分库分表能有效的缓解单机和单库带来的性能瓶颈和压力，突破网络IO、硬件资源、连接数的瓶颈，同时也带来了一些问题。
## 1、分布式事务
	更新内容同时分布在不同库中，不可避免会带来跨库事务问题。跨分片事务也是分布式事务，没有简单的方案，一般可使用"XA协议"和"两阶段提交"处理。
## 2、最终一致性
	对于那些性能要求很高，但对一致性要求不高的系统，往往不苛求系统的实时一致性，只要在允许的时间段内达到最终一致性即可，可采用事务补偿的方式。
	与事务在执行中发生错误后立即回滚的方式不同，事务补偿是一种事后检查补救的措施，一些常见的实现方法有：对数据进行对账检查，基于日志进行对比，
	定期同标准数据来源进行同步等等。事务补偿还要结合业务系统来考虑。
## 3、跨节点关联查询 join 问题
	数据切分之后，数据可能分布在不同的节点上，此时join带来的问题就比较麻烦了，考虑到性能，尽量避免使用join查询。
	解决方案：
		全局表：全局表，也可看做是"数据字典表"，就是系统中所有模块都可能依赖的一些表，为了避免跨库join查询，可以将这类表在每个数据库中都保存一份。
		字段冗余：典型的反范式设计，利用空间换时间，为了性能而避免join查询。
		数据组装：在系统层面，分两次查询，第一次查询的结果集中找出关联数据id，然后根据id发起第二次请求得到关联数据。最后将获得到的数据进行字段拼装。
		ER分片：关系型数据库中，如果可以先确定表之间的关联关系，并将那些存在关联关系的表记录存放在同一个分片上，那么就能较好的避免跨分片join问题。
					在1:1或1:n的情况下，通常按照主表的ID主键切分。
## 4、跨节点分页、排序、函数问题
	跨节点多库进行查询时，会出现limit分页、order by排序等问题。分页需要按照指定字段进行排序。
	当排序字段就是分片字段时，通过分片规则就比较容易定位到指定的分片；
	当排序字段非分片字段时，就变得比较复杂了。需要先在不同的分片节点中将数据进行排序并返回，然后将不同分片返回的结果集进行汇总和再次排序，最终返回给用户。（页数越大，系统的性能也会越差。）
	在使用Max、Min、Sum、Count之类的函数进行计算的时候，也需要先在每个分片上执行相应的函数，然后将各个分片的结果集进行汇总和再次计算，最终将结果返回。
## 5、分布式主键
	UUID
	数据库维护主键ID表（sequence 表，使用MyISAM 存储引擎）
		缺点：存在单点问题，强依赖DB，当DB异常时，整个系统都不可用。配置主从可以增加可用性，但当主库挂了，主从切换时，数据一致性在特殊情况下难以保证。
				另外性能瓶颈限制在单台MySQL的读写性能。
	Snowflake分布式自增ID算法
		Twitter的snowflake算法解决了分布式系统生成全局ID的需求，生成64位的Long型数字。
		不足就在于：强依赖机器时钟，如果时钟回拨，则可能导致生成ID重复。		
## 6、数据迁移、扩容问题
	首次分片，需要对历史数据进行迁移，一段时间内还要进行双写。
	分片集群扩容，如果采用数值范围分片，只需要添加节点就可以进行扩容了，不需要对分片数据迁移。取模的方式，历史数据需要根据新分片规则重新分片。还可以从升主（2的n次方分片）
# 四、什么时候考虑切分
### 1、能不切分尽量不要切分
	并不是所有表都需要进行切分，主要还是看数据的增长速度。切分后会在某种程度上提升业务的复杂度，数据库除了承载数据的存储和查询外。
	不到万不得已不用轻易使用分库分表这个大招，避免"过度设计"和"过早优化"。
### 2、数据量过大，正常运维影响业务访问
	对数据库备份，如果单表太大，备份时需要大量的磁盘IO和网络IO
	对一个很大的表进行DDL修改时，MySQL会锁住全表，这个时间会很长
	大表会经常访问与更新，就更有可能出现锁等待。将数据切分，用空间换时间，变相降低访问压力
### 3、随着业务发展，需要对某些字段垂直拆分
### 4、数据量快速增长
	随着业务的快速发展，单表中的数据量会持续增长，当性能接近瓶颈时，就需要考虑水平切分
### 5、安全性和可用性
	在业务层面上垂直切分，将不相关的业务的数据库分隔，因为每个业务的数据量、访问量都不同，不能因为一个业务把数据库搞挂而牵连到其他业务。
	利用水平切分，当一个数据库出现问题时，不会影响到100%的用户，每个库只承担业务的一部分数据，这样整体的可用性就能提高。
	